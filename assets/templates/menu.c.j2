// Generated menu.c from template
// Includes required LVGL and user graphics headers
#include "lvgl.h"
#include "menu_data.h"
#include "user_graphic.h"
#include <string.h>

// Helper macro to sanitize names into valid C identifiers
// Jinja macro: replaces spaces, slashes, hyphens and '&' then lowers
{% macro ident(name) -%}
{{ name | replace(' ', '_') | replace('/', '_') | replace('-', '_') | replace('&', 'and') | lower }}
{%- endmacro %}

// Forward declarations for submenu screens so event handlers can switch screens
{% for screen in config.menu.screens %}
{% for item in screen["items"] %}
{% if item.type == 'submenu' %}
static lv_obj_t *scr_{{ ident(item.name) }};
{% endif %}
{% endfor %}
{% endfor %}

// Declarations for embedded images provided via graphics_code
{% for code in graphics_code %}
{{ code }}
{% endfor %}

static void event_handler(lv_event_t *e) {
    lv_obj_t *obj = lv_event_get_target(e);
    if (lv_event_get_code(e) != LV_EVENT_CLICKED) return;
    const char *text = lv_list_get_btn_text(lv_obj_get_parent(obj), obj);
    if (!text) return;
    {% for screen in config.menu.screens %}
    {% for item in screen["items"] %}
    if (strcmp(text, "{{ item.name }}") == 0) {
        {% if item.type == 'action' and item.callback %}
        {{ item.callback }}();
        {% elif item.type == 'submenu' %}
        lv_scr_load(scr_{{ ident(item.name) }});
        {% endif %}
        return;
    }
    {% endfor %}
    {% endfor %}
}

void menu_init(void) {
    // Create main screen and any submenu screens
    lv_obj_t *scr_main = lv_obj_create(NULL);
    user_graphic_init(scr_main);
    {% for screen in config.menu.screens %}
    {% for item in screen["items"] %}
    {% if item.type == 'submenu' %}
    scr_{{ ident(item.name) }} = lv_obj_create(NULL);
    user_graphic_init(scr_{{ ident(item.name) }});
    {% endif %}
    {% endfor %}
    {% endfor %}

    // Styles for better focus visibility and spacing on monochrome OLED
    static lv_style_t style_focus;
    static lv_style_t style_normal;
    lv_style_init(&style_focus);
    lv_style_set_bg_opa(&style_focus, LV_OPA_COVER);
    lv_style_set_bg_color(&style_focus, lv_color_white());
    lv_style_set_text_color(&style_focus, lv_color_black());
    lv_style_set_border_width(&style_focus, 2);
    lv_style_set_border_color(&style_focus, lv_color_black());
    lv_style_set_outline_width(&style_focus, 1);
    lv_style_set_outline_color(&style_focus, lv_color_black());
    lv_style_set_pad_all(&style_focus, 2);

    lv_style_init(&style_normal);
    lv_style_set_pad_all(&style_normal, 1);
    lv_style_set_min_height(&style_normal, 14);

    // Build main menu list
    lv_obj_t *list_main = lv_list_create(scr_main);
    lv_obj_center(list_main);
    lv_obj_add_style(list_main, &style_focus, LV_PART_ITEMS | LV_STATE_FOCUSED);
    lv_obj_add_style(list_main, &style_normal, LV_PART_ITEMS);
    {% for screen in config.menu.screens %}
    {% for item in screen["items"] %}
    {% if item.graphic_id %}
    lv_obj_t *btn_main_{{ loop.index0 }} = lv_list_add_btn(list_main, &{{ item.graphic_id }}_dsc, "{{ item.name }}");
    {% else %}
    lv_obj_t *btn_main_{{ loop.index0 }} = lv_list_add_btn(list_main, NULL, "{{ item.name }}");
    {% endif %}
    lv_obj_add_event_cb(btn_main_{{ loop.index0 }}, event_handler, LV_EVENT_CLICKED, NULL);
    {% endfor %}
    {% endfor %}

    // Build submenu lists
    {% for screen in config.menu.screens %}
    {% for item in screen["items"] %}
    {% if item.type == 'submenu' %}
    lv_obj_t *list_{{ ident(item.name) }} = lv_list_create(scr_{{ ident(item.name) }});
    lv_obj_center(list_{{ ident(item.name) }});
    lv_obj_add_style(list_{{ ident(item.name) }}, &style_focus, LV_PART_ITEMS | LV_STATE_FOCUSED);
    lv_obj_add_style(list_{{ ident(item.name) }}, &style_normal, LV_PART_ITEMS);
        {% for subitem in item["items"] %}
        {% if subitem.graphic_id %}
        lv_obj_t *btn_{{ ident(item.name) }}_{{ loop.index0 }} = lv_list_add_btn(list_{{ ident(item.name) }}, &{{ subitem.graphic_id }}_dsc, "{{ subitem.name }}");
        {% else %}
        lv_obj_t *btn_{{ ident(item.name) }}_{{ loop.index0 }} = lv_list_add_btn(list_{{ ident(item.name) }}, NULL, "{{ subitem.name }}");
        {% endif %}
        lv_obj_add_event_cb(btn_{{ ident(item.name) }}_{{ loop.index0 }}, event_handler, LV_EVENT_CLICKED, NULL);
        {% endfor %}
    {% endif %}
    {% endfor %}
    {% endfor %}

    // Show the main screen
    lv_scr_load(scr_main);
}